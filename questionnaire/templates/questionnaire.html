<!DOCTYPE html>
<html lang="en">
<head>
    <title>Questionnaire</title>
    <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://bootswatch.com/cosmo/bootstrap.min.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        #questionnaire-name {
            text-align: center;
            font-weight: bold;
        }
        /*#questionnaire {*/
        /*width: 800pt;*/
        /*margin: auto;*/
        /*}*/
        #submit-wrapper {
            text-align: right;
            margin: 20pt 0;
        }
        .prompt {
            font-weight: bold;
        }
        .question {
            text-align: center;
            font-weight: bold;
        }
        /*.question div.low-scale {*/
        /*float: left;*/
        /*}*/
        /*.question div.high-scale {*/
        /*float: right;*/
        /*}*/
        .question img {
            width: 80pt;
        }
        .question div.answer-choices {
            display: inline-block;
            vertical-align: top;
            margin: 10pt 90pt;
        }
        .question div.answer-choices div.answer-choice {
            display: inline-block;
            vertical-align: top;
            text-align: center;
            width: 100pt;
        }
        h4 {

        }
    </style>

</head>

<body>
<h1 style="padding:0 10pt">Main Menu</h1>
<ul>


    <li><a href="/questionnaire/">Home</a></li>


    <li><a href="/questionnaire/about/">About</a></li>


    <li><a href="/questionnaire/respond/">Questionnaire</a></li>

</ul>


<hr/>

<div class="container-fluid main" style="padding:0 10pt">
    <h2 id="questionnaire-name">Healthy Habits Tracker</h2>
    <form id="questionnaire">
        <div id="questionnaire-wrapper"></div>
        <div id="submit-wrapper">
            <button class="btn btn-default" type="button" id="reset-button" onclick="javascript:resetSelections()">Reset Selections</button>
            <button class="btn btn-default" type="submit" id="submit" onclick="javascript:submitResponse()">Submit</button>
        </div>
    </form>
</div>
<script type="text/javascript">
    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    function getDisplayName() {
        var samplePatientNames = ["Leonardo", "Raphael", "Donatello", "Michaelangelo", "Zach", "Caitlin"];
        var userId = parseInt(getCookie("userId"));
        return samplePatientNames[userId-1];
    }

    function getQuestionnaire() {
        var patientQuestionnaire = [
            {
                "id": "1",
                "type": "scale",
                "prompt": "I eat veggies and fruits:",
                "choices": ["0-1 times a day", "1-2 times a day", "3-4 times a day", "More than 4 times a day"],
                "lowImg": "../static/fruit.jpg",
                "highImg": "../static/vegetables-basket.jpg"
            },
            {
                "id": "2",
                "type": "scale",
                "prompt": "I eat out:",
                "choices": ["More than 4 times a week", "3-4 times a week", "1-2 times a week", "0-1 times a week"],
                "lowImg": "../static/restaurant-crop.png",
                "highImg": "../static/pizza.jpg"
            },
            {
                "id": "3",
                "type": "scale",
                "prompt": "I am active:",
                "choices": ["Not very often", "Less than 30 minutes a day", "30-60 minutes a day", "More than 60 minutes a day"],
                "lowText": "Placeholder",
                "highText": "Placeholder"
            },
            {
                "id": "4",
                "type": "scale",
                "prompt": "I have sweet drinks (soda, sweet tea, sports drinks, 100% fruit juice, other fruit drinks):",
                "choices": ["More than 3 cups a day", "2 cups a day", "1 cup a day", "Not very often"],
                "lowImg": "../static/beverage-boxes.jpg",
                "highImg": "../static/milk-crop.png"
            },
            {
                "id": "5",
                "type": "scale",
                "prompt": "I watch television, play video games, spend (non-school related) time on a computer, tablet or cell phone:",
                "choices": ["More than 2 hours a day", "1-2 hours a day", "30-60 minutes a day", "Not very often"],
                "lowText": "Placeholder",
                "highText": "Placeholder"
            },
            {
                "id": "6",
                "type": "multi",
                "prompt": "If you could work on one healthy habit, which would it be?",
                "choices": ["Make half your plate veggies and fruits", "Be more active",
                    "Limit screen time", "Drink more water and limit sugary drinks"],
                "images": ["../static/fruit.jpg", "../static/placeholder.jpg", "../static/placeholder.jpg", "../static/water-splash.jpg"]
            },
            {
                "id": "7",
                "type": "scale",
                "prompt": "How important is it to you to work on this healthy habit?",
                "choices": ["1", "2", "3", "4"],
                "lowText": "not at all",
                "highText": "very"
            },
            {
                "id": "8",
                "type": "scale",
                "prompt": "How confident are you that you can improve this healthy habit?",
                "choices": ["1", "2", "3", "4"],
                "lowText": "not at all",
                "highText": "very"
            }
        ];
        var parentQuestionnaire = [
            {
                "id": "1",
                "type": "scale",
                "prompt": "%1$s eats veggies and fruits:",
                "choices": ["0-1 times a day", "1-2 times a day", "3-4 times a day", "More than 4 times a day"],
                "lowImg": "../static/fruit.jpg",
                "highImg": "../static/vegetables-basket.jpg"
            },
            {
                "id": "2",
                "type": "scale",
                "prompt": "%1$s is active:",
                "choices": ["Not very often", "Less than 30 minutes a day", "30-60 minutes a day", "More than 60 minutes a day"],
                "lowText": "Placeholder",
                "highText": "Placeholder"
            },
            {
                "id": "3",
                "type": "scale",
                "prompt": "%1$s drinks 100% fruit juice:",
                "choices": ["More than 3 cups a day", "2 cups a day", "1 cup a day", "Not very often"],
                "lowImg": "../static/placeholder.jpg",
                "highImg": "../static/placeholder.jpg"
            },
            {
                "id": "4",
                "type": "scale",
                "prompt": "%1$s has sweet drinks (soda, sweet tea, sports drinks, other fruit drinks):",
                "choices": ["More than 3 cups a day", "2 cups a day", "1 cup a day", "Not very often"],
                "lowImg": "../static/beverage-boxes.jpg",
                "highImg": "../static/milk-crop.png"
            },
            {
                "id": "5",
                "type": "scale",
                "prompt": "%1$s watches television, plays video games, spends (non-school related) time on a computer, tablet or cell phone:",
                "choices": ["More than 2 hours a day", "1-2 hours a day", "30-60 minutes a day", "Not very often"],
                "lowText": "Placeholder",
                "highText": "Placeholder"
            },
            {
                "id": "6",
                "type": "multi",
                "prompt": "If you and %1$s could work on one healthy habit, which would it be?",
                "choices": ["Make half your plate veggies and fruits", "Be more active",
                    "Limit screen time", "Drink more water and limit sugary drinks"],
                "images": ["../static/fruit.jpg", "../static/placeholder.jpg", "../static/placeholder.jpg", "../static/water-splash.jpg"]
            },
            {
                "id": "7",
                "type": "scale",
                "prompt": "How important is it to you that %1$s works on this healthy habit?",
                "choices": ["1", "2", "3", "4"],
                "lowText": "not at all",
                "highText": "very"
            },
            {
                "id": "8",
                "type": "scale",
                "prompt": "How confident are you that %1$s can improve on this healthy habit?",
                "choices": ["1", "2", "3", "4"],
                "lowText": "not at all",
                "highText": "very"
            }
        ];

        var questionnaire = patientQuestionnaire;

        var userId = getCookie("userId");
        switch (parseInt(userId)) {
            case 1:
            case 2:
            case 3:
            case 4:
                questionnaire = patientQuestionnaire;
                break;
            case 5:
            case 6:
                questionnaire = parentQuestionnaire;
                break;
            default:
                // invalid user ID, not in the demo users
                alert("Oops!  Select a user first to experience the demo.");
                window.location.href = "/questionnaire/";
                return [];
        }
        return questionnaire;
    }

    function resetSelections() {
        var questionnaire = getQuestionnaire();
        var patientName = getDisplayName();

        var paginate = false;
        if (paginate) {
            // TODO: multi-page version of the questionnaire
        } else {
            $('#questionnaire-wrapper').html('');
            for (var i = 0; i < questionnaire.length; i++) {
                var question = questionnaire[i];
                var node = $("<div class='row question "+question["type"]+"'>");

                var prompt = question["prompt"].replace("%1$s", patientName);
                node.append("<h4 class='prompt'>"+prompt+"</h4>");

                if (question["type"] == "scale") {
                    var lowImg = question["lowImg"];
                    var lowText = question["lowText"];
                    var lowNode = $("<div class='low-scale'>");
                    if (lowImg) lowNode.append("<img src='" + lowImg + "' />");
                    if (lowText) lowNode.append("<span>" + lowText + "</span>");
                    node.append(lowNode);
                }

                var choices = question["choices"];
                var questionId = question["id"];
                var choicesNode = $("<div class='answer-choices'>");
                for (var j = 0; j < choices.length; j++) {
                    var choice = $("<div class='radio-inline answer-choice'>");
                    if ((typeof question["images"] != "undefined") && (typeof question["images"][j] != "undefined"))
                        choice.append("<img src='"+question["images"][j]+"' />");
                    choice.append("<input type='radio' name='"+questionId+"' />");
                    choice.append("<br/>");
                    choice.append("<label for=''>"+choices[j]+"</label>");
                    choicesNode.append(choice);
                }
                node.append(choicesNode);

                if (question["type"] == "scale") {
                    var highImg = question["highImg"];
                    var highText = question["highText"];
                    var highNode = $("<div class='high-scale'>");
                    if (highImg) highNode.append("<img src='" + highImg + "' />");
                    if (highText) highNode.append("<span>" + highText + "</span>");
                    node.append(highNode);
                }
                node.append('</div>');

                $('#questionnaire-wrapper').append(node);
                $('#questionnaire-wrapper').append("</form>");
                $('#questionnaire-wrapper').append("<hr/>");
            }
        }
    }

    function validateForm() {
        errors = [];

        var questionnaire = getQuestionnaire();
        for (var i = 0; i < questionnaire.length; i++) {
            question = questionnaire[i];
            if (question["id"]) {
                var selected = $('input[name='+question["id"]+']:checked').val();
                if (typeof selected == "undefined") {
                    errors.push("You must choose an answer for '"+question["prompt"]+"'");
                }
            }
        }
        alert (errors);
        return errors;
    }

    function submitResponse() {
        var formErrors = validateForm();
        if (formErrors.length == 0) {
            alert("YAY!  You completed the form!  We haven't connected it to FHIR yet, though.");
        } else {
            alert(formErrors[0]);
        }
    }

    $(function () { resetSelections(); });

</script>

</body>

</html>